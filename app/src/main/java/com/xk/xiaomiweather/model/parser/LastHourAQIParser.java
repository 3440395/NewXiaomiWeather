package com.xk.xiaomiweather.model.parser;

import android.util.Log;

import com.xk.xiaomiweather.comm.Constant;
import com.yolanda.nohttp.NoHttp;
import com.yolanda.nohttp.RequestMethod;
import com.yolanda.nohttp.rest.Response;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.net.URLEncoder;
import java.util.HashMap;
import java.util.Map;

/**
 * 通过环境云id
 * Created by xk on 2016/11/2 21:03.
 */

public class LastHourAQIParser extends BaseParser<Map<String, String>, JSONObject> {
    private String url = Constant.BASE_ENVICLOUD_URL + "/v2/cityairhistory/" + Constant.envicloudID;
    private RequestMethod method = RequestMethod.GET;

    @Override
    public void setRequestParams(Object... params) {
        for (Object param : params) {
            url += ("/" + URLEncoder.encode(param.toString()));
        }
        request = NoHttp.createJsonObjectRequest(url, method);
    }

    @Override
    protected Map<String, String> parser(Response<JSONObject> response) {
        if (response.get() != null) {
            JSONObject object = response.get();
            Log.e("LastHourAQIParser", "parser" + object.toString());
            try {
                if (object.getInt("rcode") == 200) {
                    JSONArray historyJson = object.getJSONArray("history");
                    HashMap<String, String> stringStringHashMap = new HashMap<>();
                    for (int i = 0; i < historyJson.length(); i++) {
                        JSONObject aqi = historyJson.getJSONObject(i);
                        stringStringHashMap.put(aqi.getString("time"), aqi.getString("AQI"));
                    }
                    return stringStringHashMap;
                }
            } catch (JSONException e) {
                HashMap<String, String> stringStringHashMap = new HashMap<>();
                try {
                    JSONObject jsonObject = new JSONObject("{\"history\":[{\"citycode\":\"101010100\",\"PM25\":\"11\",\"time\":\"2017052413\",\"PM10\":\"18\",\"SO2\":\"2.25\",\"o3\":\"109.92\",\"NO2\":\"20.25\",\"primary\":\"无\",\"CO\":\"0.25\",\"AQI\":\"38\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052414\",\"PM10\":\"17\",\"SO2\":\"2.33\",\"o3\":\"129.17\",\"NO2\":\"17.92\",\"primary\":\"无\",\"CO\":\"0.22\",\"AQI\":\"42\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052415\",\"PM10\":\"15\",\"SO2\":\"2.17\",\"o3\":\"142.67\",\"NO2\":\"15.75\",\"primary\":\"无\",\"CO\":\"0.20\",\"AQI\":\"47\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052416\",\"PM10\":\"33\",\"SO2\":\"2.33\",\"o3\":\"148.42\",\"NO2\":\"16.08\",\"primary\":\"无\",\"CO\":\"0.21\",\"AQI\":\"52\"},{\"citycode\":\"101010100\",\"PM25\":\"11\",\"time\":\"2017052417\",\"PM10\":\"43\",\"SO2\":\"2.33\",\"o3\":\"145.00\",\"NO2\":\"17.50\",\"primary\":\"无\",\"CO\":\"0.20\",\"AQI\":\"56\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052418\",\"PM10\":\"53\",\"SO2\":\"2.50\",\"o3\":\"146.33\",\"NO2\":\"20.17\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.26\",\"AQI\":\"57\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052419\",\"PM10\":\"58\",\"SO2\":\"2.58\",\"o3\":\"137.58\",\"NO2\":\"24.33\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.30\",\"AQI\":\"55\"},{\"citycode\":\"101010100\",\"PM25\":\"15\",\"time\":\"2017052420\",\"PM10\":\"79\",\"SO2\":\"2.92\",\"o3\":\"125.33\",\"NO2\":\"29.33\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.32\",\"AQI\":\"64\"},{\"citycode\":\"101010100\",\"PM25\":\"15\",\"time\":\"2017052421\",\"PM10\":\"82\",\"SO2\":\"3.33\",\"o3\":\"108.58\",\"NO2\":\"33.67\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.33\",\"AQI\":\"66\"},{\"citycode\":\"101010100\",\"PM25\":\"16\",\"time\":\"2017052422\",\"PM10\":\"74\",\"SO2\":\"4.50\",\"o3\":\"93.67\",\"NO2\":\"35.08\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.35\",\"AQI\":\"61\"},{\"citycode\":\"101010100\",\"PM25\":\"20\",\"time\":\"2017052423\",\"PM10\":\"78\",\"SO2\":\"5.33\",\"o3\":\"68.83\",\"NO2\":\"54.17\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.40\",\"AQI\":\"64\"},{\"citycode\":\"101010100\",\"PM25\":\"20\",\"time\":\"2017052500\",\"PM10\":\"88\",\"SO2\":\"4.33\",\"o3\":\"42.92\",\"NO2\":\"68.17\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.44\",\"AQI\":\"68\"},{\"citycode\":\"101010100\",\"PM25\":\"21\",\"time\":\"2017052501\",\"PM10\":\"71\",\"SO2\":\"3.33\",\"o3\":\"36.83\",\"NO2\":\"63.25\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.43\",\"AQI\":\"58\"},{\"citycode\":\"101010100\",\"PM25\":\"19\",\"time\":\"2017052502\",\"PM10\":\"62\",\"SO2\":\"2.83\",\"o3\":\"23.08\",\"NO2\":\"67.50\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.46\",\"AQI\":\"54\"},{\"citycode\":\"101010100\",\"PM25\":\"18\",\"time\":\"2017052503\",\"PM10\":\"55\",\"SO2\":\"24.42\",\"o3\":\"18.58\",\"NO2\":\"63.83\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"2.27\",\"AQI\":\"51\"},{\"citycode\":\"101010100\",\"PM25\":\"15\",\"time\":\"2017052504\",\"PM10\":\"39\",\"SO2\":\"2.33\",\"o3\":\"21.50\",\"NO2\":\"61.08\",\"primary\":\"无\",\"CO\":\"0.32\",\"AQI\":\"42\"},{\"citycode\":\"101010100\",\"PM25\":\"14\",\"time\":\"2017052505\",\"PM10\":\"28\",\"SO2\":\"2.08\",\"o3\":\"27.08\",\"NO2\":\"53.92\",\"primary\":\"无\",\"CO\":\"0.23\",\"AQI\":\"36\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052506\",\"PM10\":\"33\",\"SO2\":\"2.08\",\"o3\":\"30.67\",\"NO2\":\"50.50\",\"primary\":\"无\",\"CO\":\"0.24\",\"AQI\":\"33\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052507\",\"PM10\":\"48\",\"SO2\":\"2.08\",\"o3\":\"30.33\",\"NO2\":\"50.42\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.28\",\"AQI\":\"45\"},{\"citycode\":\"101010100\",\"PM25\":\"11\",\"time\":\"2017052508\",\"PM10\":\"53\",\"SO2\":\"2.25\",\"o3\":\"36.42\",\"NO2\":\"43.92\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.33\",\"AQI\":\"49\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052509\",\"PM10\":\"45\",\"SO2\":\"2.42\",\"o3\":\"48.17\",\"NO2\":\"38.58\",\"primary\":\"无\",\"CO\":\"0.32\",\"AQI\":\"44\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052510\",\"PM10\":\"39\",\"SO2\":\"2.50\",\"o3\":\"69.75\",\"NO2\":\"27.58\",\"primary\":\"无\",\"CO\":\"0.29\",\"AQI\":\"41\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052511\",\"PM10\":\"45\",\"SO2\":\"2.92\",\"o3\":\"87.08\",\"NO2\":\"22.25\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.28\",\"AQI\":\"43\"},{\"citycode\":\"101010100\",\"PM25\":\"20\",\"time\":\"2017052512\",\"PM10\":\"77\",\"SO2\":\"7.67\",\"o3\":\"93.67\",\"NO2\":\"31.42\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.51\",\"AQI\":\"62\"}],\"rdesc\":\"Success\",\"rcode\":200}\n{\"history\":[{\"citycode\":\"101010100\",\"PM25\":\"11\",\"time\":\"2017052413\",\"PM10\":\"18\",\"SO2\":\"2.25\",\"o3\":\"109.92\",\"NO2\":\"20.25\",\"primary\":\"无\",\"CO\":\"0.25\",\"AQI\":\"38\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052414\",\"PM10\":\"17\",\"SO2\":\"2.33\",\"o3\":\"129.17\",\"NO2\":\"17.92\",\"primary\":\"无\",\"CO\":\"0.22\",\"AQI\":\"42\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052415\",\"PM10\":\"15\",\"SO2\":\"2.17\",\"o3\":\"142.67\",\"NO2\":\"15.75\",\"primary\":\"无\",\"CO\":\"0.20\",\"AQI\":\"47\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052416\",\"PM10\":\"33\",\"SO2\":\"2.33\",\"o3\":\"148.42\",\"NO2\":\"16.08\",\"primary\":\"无\",\"CO\":\"0.21\",\"AQI\":\"52\"},{\"citycode\":\"101010100\",\"PM25\":\"11\",\"time\":\"2017052417\",\"PM10\":\"43\",\"SO2\":\"2.33\",\"o3\":\"145.00\",\"NO2\":\"17.50\",\"primary\":\"无\",\"CO\":\"0.20\",\"AQI\":\"56\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052418\",\"PM10\":\"53\",\"SO2\":\"2.50\",\"o3\":\"146.33\",\"NO2\":\"20.17\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.26\",\"AQI\":\"57\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052419\",\"PM10\":\"58\",\"SO2\":\"2.58\",\"o3\":\"137.58\",\"NO2\":\"24.33\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.30\",\"AQI\":\"55\"},{\"citycode\":\"101010100\",\"PM25\":\"15\",\"time\":\"2017052420\",\"PM10\":\"79\",\"SO2\":\"2.92\",\"o3\":\"125.33\",\"NO2\":\"29.33\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.32\",\"AQI\":\"64\"},{\"citycode\":\"101010100\",\"PM25\":\"15\",\"time\":\"2017052421\",\"PM10\":\"82\",\"SO2\":\"3.33\",\"o3\":\"108.58\",\"NO2\":\"33.67\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.33\",\"AQI\":\"66\"},{\"citycode\":\"101010100\",\"PM25\":\"16\",\"time\":\"2017052422\",\"PM10\":\"74\",\"SO2\":\"4.50\",\"o3\":\"93.67\",\"NO2\":\"35.08\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.35\",\"AQI\":\"61\"},{\"citycode\":\"101010100\",\"PM25\":\"20\",\"time\":\"2017052423\",\"PM10\":\"78\",\"SO2\":\"5.33\",\"o3\":\"68.83\",\"NO2\":\"54.17\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.40\",\"AQI\":\"64\"},{\"citycode\":\"101010100\",\"PM25\":\"20\",\"time\":\"2017052500\",\"PM10\":\"88\",\"SO2\":\"4.33\",\"o3\":\"42.92\",\"NO2\":\"68.17\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.44\",\"AQI\":\"68\"},{\"citycode\":\"101010100\",\"PM25\":\"21\",\"time\":\"2017052501\",\"PM10\":\"71\",\"SO2\":\"3.33\",\"o3\":\"36.83\",\"NO2\":\"63.25\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.43\",\"AQI\":\"58\"},{\"citycode\":\"101010100\",\"PM25\":\"19\",\"time\":\"2017052502\",\"PM10\":\"62\",\"SO2\":\"2.83\",\"o3\":\"23.08\",\"NO2\":\"67.50\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.46\",\"AQI\":\"54\"},{\"citycode\":\"101010100\",\"PM25\":\"18\",\"time\":\"2017052503\",\"PM10\":\"55\",\"SO2\":\"24.42\",\"o3\":\"18.58\",\"NO2\":\"63.83\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"2.27\",\"AQI\":\"51\"},{\"citycode\":\"101010100\",\"PM25\":\"15\",\"time\":\"2017052504\",\"PM10\":\"39\",\"SO2\":\"2.33\",\"o3\":\"21.50\",\"NO2\":\"61.08\",\"primary\":\"无\",\"CO\":\"0.32\",\"AQI\":\"42\"},{\"citycode\":\"101010100\",\"PM25\":\"14\",\"time\":\"2017052505\",\"PM10\":\"28\",\"SO2\":\"2.08\",\"o3\":\"27.08\",\"NO2\":\"53.92\",\"primary\":\"无\",\"CO\":\"0.23\",\"AQI\":\"36\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052506\",\"PM10\":\"33\",\"SO2\":\"2.08\",\"o3\":\"30.67\",\"NO2\":\"50.50\",\"primary\":\"无\",\"CO\":\"0.24\",\"AQI\":\"33\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052507\",\"PM10\":\"48\",\"SO2\":\"2.08\",\"o3\":\"30.33\",\"NO2\":\"50.42\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.28\",\"AQI\":\"45\"},{\"citycode\":\"101010100\",\"PM25\":\"11\",\"time\":\"2017052508\",\"PM10\":\"53\",\"SO2\":\"2.25\",\"o3\":\"36.42\",\"NO2\":\"43.92\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.33\",\"AQI\":\"49\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052509\",\"PM10\":\"45\",\"SO2\":\"2.42\",\"o3\":\"48.17\",\"NO2\":\"38.58\",\"primary\":\"无\",\"CO\":\"0.32\",\"AQI\":\"44\"},{\"citycode\":\"101010100\",\"PM25\":\"12\",\"time\":\"2017052510\",\"PM10\":\"39\",\"SO2\":\"2.50\",\"o3\":\"69.75\",\"NO2\":\"27.58\",\"primary\":\"无\",\"CO\":\"0.29\",\"AQI\":\"41\"},{\"citycode\":\"101010100\",\"PM25\":\"10\",\"time\":\"2017052511\",\"PM10\":\"45\",\"SO2\":\"2.92\",\"o3\":\"87.08\",\"NO2\":\"22.25\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.28\",\"AQI\":\"43\"},{\"citycode\":\"101010100\",\"PM25\":\"20\",\"time\":\"2017052512\",\"PM10\":\"77\",\"SO2\":\"7.67\",\"o3\":\"93.67\",\"NO2\":\"31.42\",\"primary\":\"颗粒物(PM10)\",\"CO\":\"0.51\",\"AQI\":\"62\"}],\"rdesc\":\"Success\",\"rcode\":200}\n");
                    JSONArray historyJson = jsonObject.getJSONArray("history");
                    for (int i = 0; i < historyJson.length(); i++) {
                        JSONObject aqi = historyJson.getJSONObject(i);
                        stringStringHashMap.put(aqi.getString("time"), aqi.getString("AQI"));
                    }
                    Log.e("api挂了", "LastHourAQI");
                } catch (JSONException e1) {
                    e1.printStackTrace();
                }
                Log.e("LastHourAQIParser", "返回的json" + object.toString());
                e.printStackTrace();
                return stringStringHashMap;
            }
        }
        return null;
    }
}
